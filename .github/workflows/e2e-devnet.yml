name: e2e-devnet

on:
  workflow_dispatch:
    inputs:
      deployment:
        description: "Base deployment name from deployments.json (workflow creates a fresh deployment_id + config PDAs per run)"
        required: true
        type: string
      net_amount_a:
        description: "Direction A net amount (SPL tokens, u64)"
        required: false
        default: "1000"
        type: string
      net_amount_b:
        description: "Direction B net amount (SPL tokens, u64)"
        required: false
        default: "1000"
        type: string
      junocash_amount_a:
        description: "Direction A JunoCash send amount (float, coins)"
        required: false
        default: "1.0"
        type: string
      junocash_amount_b:
        description: "Direction B JunoCash send amount (float, coins)"
        required: false
        default: "0.5"
        type: string
      priority_level:
        description: "Helius priority level (Min/Low/Medium/High/VeryHigh/UnsafeMax)"
        required: false
        default: "Medium"
        type: string

concurrency:
  group: e2e-devnet-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUST_TOOLCHAIN: 1.91.1
  RISC0_RUST_TOOLCHAIN: 1.91.1
  RZUP_VERSION: 0.5.1
  SOLANA_CLI_VERSION: 3.1.6
  HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}
  HELIUS_CLUSTER: devnet
  JUNO_E2E_NET_AMOUNT_A: ${{ github.event.inputs.net_amount_a }}
  JUNO_E2E_NET_AMOUNT_B: ${{ github.event.inputs.net_amount_b }}
  JUNO_E2E_JUNOCASH_SEND_AMOUNT_A: ${{ github.event.inputs.junocash_amount_a }}
  JUNO_E2E_JUNOCASH_SEND_AMOUNT_B: ${{ github.event.inputs.junocash_amount_b }}
  JUNO_E2E_PRIORITY_LEVEL: ${{ github.event.inputs.priority_level }}

jobs:
  e2e:
    runs-on: runs-on=${{ github.run_id }}/family=g5.4xlarge/image=ubuntu22-gpu-x64/spot=false/extras=s3-cache
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.mod

      - name: RunsOn cache
        uses: runs-on/action@v2
        with:
          sccache: s3

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: GPU prerequisites
        run: |
          set -euo pipefail
          nvidia-smi
          nvcc --version

      - name: Install system deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends protobuf-compiler
          if ! command -v docker >/dev/null; then
            sudo apt-get install -y --no-install-recommends docker.io
          fi
          sudo systemctl start docker || sudo service docker start || true
          docker ps >/dev/null

      - name: Install Solana CLI
        run: |
          set -euo pipefail
          SOLANA_DIR="$HOME/.local/share/solana/solana-release"
          if [[ ! -x "${SOLANA_DIR}/bin/solana" ]]; then
            rm -rf "${SOLANA_DIR}"
            mkdir -p "$HOME/.local/share/solana"
            curl -sSfL --retry 8 --retry-delay 5 --retry-all-errors \
              "https://github.com/anza-xyz/agave/releases/download/v${SOLANA_CLI_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
              -o /tmp/solana-release.tar.bz2
            tar -xjf /tmp/solana-release.tar.bz2 -C "$HOME/.local/share/solana"
          fi
          echo "${SOLANA_DIR}/bin" >> "$GITHUB_PATH"
          export PATH="${SOLANA_DIR}/bin:$PATH"
          solana --version
          spl-token --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ env.RUST_TOOLCHAIN }}
          workspaces: |
            risc0/receipt -> target
            solana -> target

      - name: Cache RISC0 toolchain
        uses: actions/cache@v4
        with:
          path: ~/.risc0
          key: ${{ runner.os }}-risc0-rzup-rust-${{ env.RISC0_RUST_TOOLCHAIN }}

      - name: Install rzup
        run: |
          set -euo pipefail
          if command -v rzup >/dev/null && rzup --version | grep -q "${{ env.RZUP_VERSION }}"; then
            echo "rzup already installed: $(rzup --version)"
            exit 0
          fi
          cargo install rzup --version ${{ env.RZUP_VERSION }} --locked --force

      - name: Install RISC0 toolchain + Groth16 component
        run: |
          set -euo pipefail
          rzup install rust ${{ env.RISC0_RUST_TOOLCHAIN }}
          rzup install risc0-groth16 0.1.0

      - name: Write CRP operator keypairs
        run: |
          set -euo pipefail
          mkdir -p /tmp/juno-secrets
          printf '%s' "${{ secrets.JUNO_CRP_OPERATOR1_KEYPAIR_JSON }}" > /tmp/juno-secrets/crp-operator-1.json
          printf '%s' "${{ secrets.JUNO_CRP_OPERATOR2_KEYPAIR_JSON }}" > /tmp/juno-secrets/crp-operator-2.json
          printf '%s' "${{ secrets.JUNO_E2E_SOLVER_KEYPAIR_JSON }}" > /tmp/juno-secrets/solver.json
          printf '%s' "${{ secrets.JUNO_E2E_CREATOR_KEYPAIR_JSON }}" > /tmp/juno-secrets/creator.json
          chmod 600 /tmp/juno-secrets/crp-operator-1.json /tmp/juno-secrets/crp-operator-2.json
          chmod 600 /tmp/juno-secrets/solver.json /tmp/juno-secrets/creator.json
          echo "JUNO_E2E_CRP_OPERATOR1_KEYPAIR=/tmp/juno-secrets/crp-operator-1.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_CRP_OPERATOR2_KEYPAIR=/tmp/juno-secrets/crp-operator-2.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_SOLVER_KEYPAIR=/tmp/juno-secrets/solver.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_CREATOR_KEYPAIR=/tmp/juno-secrets/creator.json" >> "$GITHUB_ENV"

      - name: Normalize Helius env (RPC + priority fees)
        run: |
          set -euo pipefail
          raw_key="${HELIUS_API_KEY:-}"
          raw_url="${{ secrets.HELIUS_RPC_URL }}"
          key=""
          if [[ -n "${raw_key}" && "${raw_key}" != http* ]]; then
            key="${raw_key}"
          fi
          if [[ -z "${key}" ]]; then
            if [[ -n "${raw_key}" && "${raw_key}" == http* ]]; then
              raw_url="${raw_key}"
            fi
            if [[ -n "${raw_url}" ]]; then
              key="$(python3 - "${raw_url}" <<'PY'\nimport sys\nfrom urllib.parse import urlparse, parse_qs\nu=urlparse(sys.argv[1])\nq=parse_qs(u.query)\nprint((q.get('api-key') or [''])[0])\nPY\n)"
            fi
          fi
          if [[ -z "${key}" ]]; then
            echo "HELIUS_API_KEY missing; priority fee hints disabled" >&2
            exit 0
          fi
          devnet_url="https://devnet.helius-rpc.com/?api-key=${key}"
          echo "HELIUS_API_KEY=${key}" >> "$GITHUB_ENV"
          echo "HELIUS_CLUSTER=devnet" >> "$GITHUB_ENV"
          echo "HELIUS_RPC_URL=${devnet_url}" >> "$GITHUB_ENV"

      - name: Prepare ephemeral deployment (init CRP + IEP)
        run: |
          set -euo pipefail

          base_deployment="${{ github.event.inputs.deployment }}"
          e2e_deployment="e2e-${GITHUB_RUN_ID}"
          deployment_id="$(openssl rand -hex 32)"

          echo "base_deployment=${base_deployment}" >&2
          echo "e2e_deployment=${e2e_deployment}" >&2
          echo "deployment_id=${deployment_id}" >&2

          while IFS='=' read -r k v; do
            export "${k}=${v}"
          done < <(python3 - "${base_deployment}" <<'PY'
          import json,sys
          name=sys.argv[1]
          with open("deployments.json","r",encoding="utf-8") as f:
            reg=json.load(f)
          entry=None
          for it in reg.get("deployments") or []:
            if it.get("name")==name:
              entry=it
              break
          if entry is None:
            raise SystemExit(f"deployment not found: {name}")
          def emit(k, v):
            if v is None:
              return
            print(f"{k}={v}")
          emit("RPC_URL", entry.get("rpc_url"))
          emit("ADMIN", entry.get("admin"))
          emit("FEE_BPS", entry.get("fee_bps"))
          emit("FEE_COLLECTOR", entry.get("fee_collector"))
          emit("CRP_PROGRAM_ID", entry.get("checkpoint_registry_program_id"))
          emit("IEP_PROGRAM_ID", entry.get("intent_escrow_program_id"))
          emit("RV_PROGRAM_ID", entry.get("receipt_verifier_program_id"))
          emit("VERIFIER_ROUTER_PROGRAM_ID", entry.get("verifier_router_program_id"))
          emit("VERIFIER_ROUTER", entry.get("verifier_router"))
          emit("VERIFIER_ENTRY", entry.get("verifier_entry"))
          emit("VERIFIER_PROGRAM_ID", entry.get("verifier_program_id"))
          emit("JUNOCASH_CHAIN", entry.get("junocash_chain"))
          emit("JUNOCASH_GENESIS_HASH", entry.get("junocash_genesis_hash"))
          emit("ADDRESS_LOOKUP_TABLE", entry.get("address_lookup_table"))
          PY
          )

          if [[ -z "${RPC_URL:-}" || -z "${ADMIN:-}" || -z "${FEE_BPS:-}" || -z "${FEE_COLLECTOR:-}" ]]; then
            echo "base deployment missing required fields (rpc_url/admin/fee_bps/fee_collector)" >&2
            exit 1
          fi
          if [[ -z "${CRP_PROGRAM_ID:-}" || -z "${IEP_PROGRAM_ID:-}" || -z "${RV_PROGRAM_ID:-}" ]]; then
            echo "base deployment missing required program IDs (CRP/IEP/RV)" >&2
            exit 1
          fi
          if [[ -z "${VERIFIER_ROUTER_PROGRAM_ID:-}" || -z "${VERIFIER_ROUTER:-}" || -z "${VERIFIER_ENTRY:-}" || -z "${VERIFIER_PROGRAM_ID:-}" ]]; then
            echo "base deployment missing required verifier router fields" >&2
            exit 1
          fi
          if [[ -z "${JUNOCASH_CHAIN:-}" || -z "${JUNOCASH_GENESIS_HASH:-}" ]]; then
            echo "base deployment missing required JunoCash chain info (junocash_chain/junocash_genesis_hash)" >&2
            exit 1
          fi

          op1_pub="$(solana-keygen pubkey /tmp/juno-secrets/crp-operator-1.json)"
          op2_pub="$(solana-keygen pubkey /tmp/juno-secrets/crp-operator-2.json)"

          rpc="${HELIUS_RPC_URL:-${RPC_URL}}"
          echo "solana_rpc_url=${rpc}" >&2

          crp_log="$(SOLANA_RPC_URL="${rpc}" go run ./cmd/juno-intents init-crp \
            --crp-program-id "${CRP_PROGRAM_ID}" \
            --deployment-id "${deployment_id}" \
            --admin "${ADMIN}" \
            --threshold 2 \
            --conflict-threshold 2 \
            --finalization-delay-slots 0 \
            --operator "${op1_pub}" \
            --operator "${op2_pub}" \
            --payer-keypair /tmp/juno-secrets/solver.json 2>&1)"
          echo "${crp_log}" >&2
          crp_config="$(printf '%s\n' "${crp_log}" | sed -nE 's/^crp_config=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | tail -n 1)"
          if [[ -z "${crp_config}" ]]; then
            echo "failed to parse crp_config from init-crp output" >&2
            exit 1
          fi

          iep_log="$(SOLANA_RPC_URL="${rpc}" go run ./cmd/juno-intents init-iep \
            --iep-program-id "${IEP_PROGRAM_ID}" \
            --deployment-id "${deployment_id}" \
            --fee-bps "${FEE_BPS}" \
            --fee-collector "${FEE_COLLECTOR}" \
            --checkpoint-registry-program "${CRP_PROGRAM_ID}" \
            --receipt-verifier-program "${RV_PROGRAM_ID}" \
            --verifier-router-program "${VERIFIER_ROUTER_PROGRAM_ID}" \
            --verifier-router "${VERIFIER_ROUTER}" \
            --verifier-entry "${VERIFIER_ENTRY}" \
            --verifier-program "${VERIFIER_PROGRAM_ID}" \
            --payer-keypair /tmp/juno-secrets/solver.json 2>&1)"
          echo "${iep_log}" >&2
          iep_config="$(printf '%s\n' "${iep_log}" | sed -nE 's/^iep_config=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | tail -n 1)"
          if [[ -z "${iep_config}" ]]; then
            echo "failed to parse iep_config from init-iep output" >&2
            exit 1
          fi

          tmp_deployments="/tmp/juno-deployments-e2e.json"
          python3 - <<PY
          import json,time
          entry = {
            "name": "${e2e_deployment}",
            "cluster": "devnet",
            "rpc_url": "${RPC_URL}",
            "created_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
            "deployment_id": "${deployment_id}",
            "junocash_chain": "${JUNOCASH_CHAIN}",
            "junocash_genesis_hash": "${JUNOCASH_GENESIS_HASH}",
            "admin": "${ADMIN}",
            "checkpoint_registry_program_id": "${CRP_PROGRAM_ID}",
            "intent_escrow_program_id": "${IEP_PROGRAM_ID}",
            "receipt_verifier_program_id": "${RV_PROGRAM_ID}",
            "crp_config": "${crp_config}",
            "iep_config": "${iep_config}",
            "fee_bps": int("${FEE_BPS}"),
            "fee_collector": "${FEE_COLLECTOR}",
            "verifier_router_program_id": "${VERIFIER_ROUTER_PROGRAM_ID}",
            "verifier_router": "${VERIFIER_ROUTER}",
            "verifier_entry": "${VERIFIER_ENTRY}",
            "verifier_program_id": "${VERIFIER_PROGRAM_ID}",
            "crp_threshold": 2,
            "crp_conflict_threshold": 2,
            "crp_finalization_delay_slots": 0,
            "crp_operators": ["${op1_pub}","${op2_pub}"],
            "upgrade_mode": "final",
          }
          alt = "${ADDRESS_LOOKUP_TABLE:-}"
          if alt:
            entry["address_lookup_table"] = alt
          out = {"deployments": [entry]}
          with open("${tmp_deployments}", "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2, sort_keys=True)
            f.write("\\n")
          PY

          echo "JUNO_E2E_DEPLOYMENT_NAME=${e2e_deployment}" >> "$GITHUB_ENV"
          echo "JUNO_E2E_DEPLOYMENT_FILE=${tmp_deployments}" >> "$GITHUB_ENV"

      - name: Run devnet e2e (both directions)
        env:
          RUST_LOG: info
        run: |
          set -euo pipefail
          ./scripts/e2e/devnet-testnet.sh \
            --deployment "${JUNO_E2E_DEPLOYMENT_NAME}" \
            --deployment-file "${JUNO_E2E_DEPLOYMENT_FILE}"
