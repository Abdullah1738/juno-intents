name: e2e-devnet

on:
  workflow_dispatch:
    inputs:
      deployment:
        description: "Base deployment name from deployments.json (workflow creates a fresh deployment_id + config PDAs per run)"
        required: true
        type: string
      crp_mode:
        description: "CRP config mode: v1 (no ORP) or v2 (requires ORP operator records)"
        required: false
        default: "v1"
        type: choice
        options:
          - v1
          - v2
      net_amount_a:
        description: "Direction A net amount (SPL tokens, u64)"
        required: false
        default: "1000"
        type: string
      net_amount_b:
        description: "Direction B net amount (SPL tokens, u64)"
        required: false
        default: "1000"
        type: string
      junocash_amount_a:
        description: "Direction A JunoCash send amount (float, coins)"
        required: false
        default: "1.0"
        type: string
      junocash_amount_b:
        description: "Direction B JunoCash send amount (float, coins)"
        required: false
        default: "0.5"
        type: string
      priority_level:
        description: "Helius priority level (Min/Low/Medium/High/VeryHigh/UnsafeMax)"
        required: false
        default: "Medium"
        type: string

concurrency:
  group: e2e-devnet-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUST_TOOLCHAIN: 1.91.1
  RISC0_RUST_TOOLCHAIN: 1.91.1
  RZUP_VERSION: 0.5.1
  SOLANA_CLI_VERSION: 3.1.6
  HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}
  HELIUS_CLUSTER: devnet
  JUNO_E2E_CRP_MODE: ${{ github.event.inputs.crp_mode }}
  JUNO_E2E_NET_AMOUNT_A: ${{ github.event.inputs.net_amount_a }}
  JUNO_E2E_NET_AMOUNT_B: ${{ github.event.inputs.net_amount_b }}
  JUNO_E2E_JUNOCASH_SEND_AMOUNT_A: ${{ github.event.inputs.junocash_amount_a }}
  JUNO_E2E_JUNOCASH_SEND_AMOUNT_B: ${{ github.event.inputs.junocash_amount_b }}
  JUNO_E2E_PRIORITY_LEVEL: ${{ github.event.inputs.priority_level }}

jobs:
  e2e:
    runs-on: runs-on=${{ github.run_id }}/family=g5.4xlarge/image=ubuntu22-gpu-x64/spot=false/extras=s3-cache
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.mod

      - name: RunsOn cache
        uses: runs-on/action@v2
        with:
          sccache: s3

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: GPU prerequisites
        run: |
          set -euo pipefail
          nvidia-smi
          nvcc --version

      - name: Install system deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends protobuf-compiler
          if ! command -v docker >/dev/null; then
            sudo apt-get install -y --no-install-recommends docker.io
          fi
          sudo systemctl start docker || sudo service docker start || true
          docker ps >/dev/null

      - name: Install Nitro Enclaves CLI (v2)
        if: ${{ env.JUNO_E2E_CRP_MODE == 'v2' }}
        run: |
          set -euo pipefail
          if command -v nitro-cli >/dev/null; then
            nitro-cli --version || true
            exit 0
          fi
          sudo apt-get update
          if sudo apt-get install -y --no-install-recommends aws-nitro-enclaves-cli; then
            :
          elif sudo apt-get install -y --no-install-recommends nitro-enclaves-cli; then
            :
          else
            echo "failed to install Nitro Enclaves CLI via apt" >&2
            apt-cache search nitro-enclaves || true
            exit 1
          fi
          nitro-cli --version

      - name: Install Solana CLI
        run: |
          set -euo pipefail
          SOLANA_DIR="$HOME/.local/share/solana/solana-release"
          if [[ ! -x "${SOLANA_DIR}/bin/solana" ]]; then
            rm -rf "${SOLANA_DIR}"
            mkdir -p "$HOME/.local/share/solana"
            curl -sSfL --retry 8 --retry-delay 5 --retry-all-errors \
              "https://github.com/anza-xyz/agave/releases/download/v${SOLANA_CLI_VERSION}/solana-release-x86_64-unknown-linux-gnu.tar.bz2" \
              -o /tmp/solana-release.tar.bz2
            tar -xjf /tmp/solana-release.tar.bz2 -C "$HOME/.local/share/solana"
          fi
          echo "${SOLANA_DIR}/bin" >> "$GITHUB_PATH"
          export PATH="${SOLANA_DIR}/bin:$PATH"
          solana --version
          spl-token --version

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-${{ env.RUST_TOOLCHAIN }}
          workspaces: |
            risc0/attestation -> target
            risc0/receipt -> target
            solana -> target

      - name: Cache RISC0 toolchain
        uses: actions/cache@v4
        with:
          path: ~/.risc0
          key: ${{ runner.os }}-risc0-rzup-rust-${{ env.RISC0_RUST_TOOLCHAIN }}

      - name: Install rzup
        run: |
          set -euo pipefail
          if command -v rzup >/dev/null && rzup --version | grep -q "${{ env.RZUP_VERSION }}"; then
            echo "rzup already installed: $(rzup --version)"
            exit 0
          fi
          cargo install rzup --version ${{ env.RZUP_VERSION }} --locked --force

      - name: Install RISC0 toolchain + Groth16 component
        run: |
          set -euo pipefail
          rzup install rust ${{ env.RISC0_RUST_TOOLCHAIN }}
          rzup install risc0-groth16 0.1.0

      - name: Write CRP operator keypairs
        run: |
          set -euo pipefail
          mkdir -p /tmp/juno-secrets
          printf '%s' "${{ secrets.JUNO_CRP_OPERATOR1_KEYPAIR_JSON }}" > /tmp/juno-secrets/crp-operator-1.json
          printf '%s' "${{ secrets.JUNO_CRP_OPERATOR2_KEYPAIR_JSON }}" > /tmp/juno-secrets/crp-operator-2.json
          printf '%s' "${{ secrets.JUNO_E2E_SOLVER_KEYPAIR_JSON }}" > /tmp/juno-secrets/solver.json
          printf '%s' "${{ secrets.JUNO_E2E_CREATOR_KEYPAIR_JSON }}" > /tmp/juno-secrets/creator.json
          chmod 600 /tmp/juno-secrets/crp-operator-1.json /tmp/juno-secrets/crp-operator-2.json
          chmod 600 /tmp/juno-secrets/solver.json /tmp/juno-secrets/creator.json
          echo "JUNO_E2E_CRP_OPERATOR1_KEYPAIR=/tmp/juno-secrets/crp-operator-1.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_CRP_OPERATOR2_KEYPAIR=/tmp/juno-secrets/crp-operator-2.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_SOLVER_KEYPAIR=/tmp/juno-secrets/solver.json" >> "$GITHUB_ENV"
          echo "JUNO_E2E_CREATOR_KEYPAIR=/tmp/juno-secrets/creator.json" >> "$GITHUB_ENV"

      - name: Normalize Helius env (RPC + priority fees)
        run: |
          set -euo pipefail
          raw_key="${HELIUS_API_KEY:-}"
          raw_url="${{ secrets.HELIUS_RPC_URL }}"
          key=""
          if [[ -n "${raw_key}" && "${raw_key}" != http* ]]; then
            key="${raw_key}"
          fi
          if [[ -z "${key}" ]]; then
            if [[ -n "${raw_key}" && "${raw_key}" == http* ]]; then
              raw_url="${raw_key}"
            fi
            if [[ -n "${raw_url}" ]]; then
              key="$(python3 - "${raw_url}" <<'PY'\nimport sys\nfrom urllib.parse import urlparse, parse_qs\nu=urlparse(sys.argv[1])\nq=parse_qs(u.query)\nprint((q.get('api-key') or [''])[0])\nPY\n)"
            fi
          fi
          if [[ -z "${key}" ]]; then
            echo "HELIUS_API_KEY missing; priority fee hints disabled" >&2
            exit 0
          fi
          devnet_url="https://devnet.helius-rpc.com/?api-key=${key}"
          echo "HELIUS_API_KEY=${key}" >> "$GITHUB_ENV"
          echo "HELIUS_CLUSTER=devnet" >> "$GITHUB_ENV"
          echo "HELIUS_RPC_URL=${devnet_url}" >> "$GITHUB_ENV"

      - name: Load base deployment + generate deployment_id
        run: |
          set -euo pipefail

          base_deployment="${{ github.event.inputs.deployment }}"
          e2e_deployment="e2e-${GITHUB_RUN_ID}"
          deployment_id="$(openssl rand -hex 32)"

          echo "base_deployment=${base_deployment}" >&2
          echo "e2e_deployment=${e2e_deployment}" >&2
          echo "deployment_id=${deployment_id}" >&2

          {
            echo "JUNO_E2E_BASE_DEPLOYMENT=${base_deployment}"
            echo "JUNO_E2E_DEPLOYMENT_NAME=${e2e_deployment}"
            echo "JUNO_E2E_DEPLOYMENT_ID=${deployment_id}"
          } >> "$GITHUB_ENV"

          python3 - "${base_deployment}" <<'PY' >> "$GITHUB_ENV"
          import json,sys
          name=sys.argv[1]
          with open("deployments.json","r",encoding="utf-8") as f:
            reg=json.load(f)
          entry=None
          for it in reg.get("deployments") or []:
            if it.get("name")==name:
              entry=it
              break
          if entry is None:
            raise SystemExit(f"deployment not found: {name}")
          def emit(k, v):
            if v is None:
              return
            print(f"{k}={v}")
          emit("RPC_URL", entry.get("rpc_url"))
          emit("ADMIN", entry.get("admin"))
          emit("FEE_BPS", entry.get("fee_bps"))
          emit("FEE_COLLECTOR", entry.get("fee_collector"))
          emit("CRP_PROGRAM_ID", entry.get("checkpoint_registry_program_id"))
          emit("ORP_PROGRAM_ID", entry.get("operator_registry_program_id"))
          emit("IEP_PROGRAM_ID", entry.get("intent_escrow_program_id"))
          emit("RV_PROGRAM_ID", entry.get("receipt_verifier_program_id"))
          emit("VERIFIER_ROUTER_PROGRAM_ID", entry.get("verifier_router_program_id"))
          emit("VERIFIER_ROUTER", entry.get("verifier_router"))
          emit("VERIFIER_ENTRY", entry.get("verifier_entry"))
          emit("VERIFIER_PROGRAM_ID", entry.get("verifier_program_id"))
          emit("JUNOCASH_CHAIN", entry.get("junocash_chain"))
          emit("JUNOCASH_GENESIS_HASH", entry.get("junocash_genesis_hash"))
          emit("ADDRESS_LOOKUP_TABLE", entry.get("address_lookup_table"))
          PY

      - name: Setup ORP operators via Nitro enclaves (v2)
        if: ${{ env.JUNO_E2E_CRP_MODE == 'v2' }}
        run: |
          set -euo pipefail

          if [[ -z "${RPC_URL:-}" || -z "${ORP_PROGRAM_ID:-}" ]]; then
            echo "missing RPC_URL or ORP_PROGRAM_ID from base deployment" >&2
            exit 1
          fi
          if [[ -z "${VERIFIER_ROUTER_PROGRAM_ID:-}" || -z "${VERIFIER_PROGRAM_ID:-}" ]]; then
            echo "missing verifier router fields from base deployment" >&2
            exit 1
          fi
          if [[ -z "${JUNO_E2E_DEPLOYMENT_ID:-}" ]]; then
            echo "missing JUNO_E2E_DEPLOYMENT_ID" >&2
            exit 1
          fi
          if [[ -z "${JUNOCASH_CHAIN:-}" || -z "${JUNOCASH_GENESIS_HASH:-}" ]]; then
            echo "missing JunoCash chain fields from base deployment" >&2
            exit 1
          fi

          if [[ ! -e /dev/nitro_enclaves ]]; then
            echo "/dev/nitro_enclaves missing; runner not configured with Nitro Enclaves enabled" >&2
            ls -la /dev/nitro_enclaves || true
            exit 1
          fi

          sudo mkdir -p /etc/nitro_enclaves
          cat <<'EOF' | sudo tee /etc/nitro_enclaves/allocator.yaml >/dev/null
          memory_mib: 4096
          cpu_count: 4
          EOF
          sudo systemctl restart nitro-enclaves-allocator || sudo service nitro-enclaves-allocator restart || true
          sudo systemctl status nitro-enclaves-allocator --no-pager || true

          CID1=16
          CID2=17
          PORT=5000

          go build -o /tmp/nitro-operator ./cmd/nitro-operator
          go build -o /tmp/juno-intents ./cmd/juno-intents

          echo "building EIF..." >&2
          JUNO_EIF_DOCKERFILE=enclave/operator/Dockerfile.e2e \
            JUNO_EIF_OUT_DIR=/tmp/juno-eif \
            JUNO_EIF_OUT_EIF=/tmp/juno-eif/operator.eif \
            ./scripts/enclave/build-eif.sh

          echo "running enclaves..." >&2
          e1_json="$(sudo nitro-cli run-enclave --eif-path /tmp/juno-eif/operator.eif --cpu-count 2 --memory 1024 --enclave-cid "${CID1}")"
          e2_json="$(sudo nitro-cli run-enclave --eif-path /tmp/juno-eif/operator.eif --cpu-count 2 --memory 1024 --enclave-cid "${CID2}")"

          e1_id="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1])["EnclaveID"])' "${e1_json}")"
          e2_id="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1])["EnclaveID"])' "${e2_json}")"
          echo "enclave1_id=${e1_id}" >&2
          echo "enclave2_id=${e2_id}" >&2

          {
            echo "JUNO_E2E_NITRO_ENCLAVE_ID1=${e1_id}"
            echo "JUNO_E2E_NITRO_ENCLAVE_ID2=${e2_id}"
            echo "JUNO_E2E_CRP_SUBMIT_ENCLAVE_CID1=${CID1}"
            echo "JUNO_E2E_CRP_SUBMIT_ENCLAVE_CID2=${CID2}"
            echo "JUNO_E2E_CRP_SUBMIT_ENCLAVE_PORT=${PORT}"
          } >> "$GITHUB_ENV"

          echo "querying enclave pubkeys..." >&2
          op1_info="$(sudo -E /tmp/nitro-operator pubkey --enclave-cid "${CID1}" --enclave-port "${PORT}")"
          op2_info="$(sudo -E /tmp/nitro-operator pubkey --enclave-cid "${CID2}" --enclave-port "${PORT}")"
          echo "${op1_info}" >&2
          echo "${op2_info}" >&2

          case "$(printf '%s' "${JUNOCASH_CHAIN}" | tr '[:upper:]' '[:lower:]' | tr -d ' \t\r\n')" in
            mainnet) CHAIN_ID=1 ;;
            testnet) CHAIN_ID=2 ;;
            regtest) CHAIN_ID=3 ;;
            *) echo "unsupported JUNOCASH_CHAIN: ${JUNOCASH_CHAIN}" >&2; exit 1 ;;
          esac

          echo "building attestation witnesses..." >&2
          w1="$(sudo -E /tmp/nitro-operator witness --enclave-cid "${CID1}" --enclave-port "${PORT}" --deployment-id "${JUNO_E2E_DEPLOYMENT_ID}" --junocash-chain-id "${CHAIN_ID}" --junocash-genesis-hash "${JUNOCASH_GENESIS_HASH}")"
          w2="$(sudo -E /tmp/nitro-operator witness --enclave-cid "${CID2}" --enclave-port "${PORT}" --deployment-id "${JUNO_E2E_DEPLOYMENT_ID}" --junocash-chain-id "${CHAIN_ID}" --junocash-genesis-hash "${JUNOCASH_GENESIS_HASH}")"

          echo "proving attestation bundles (CUDA)..." >&2
          b1="$(cargo run --release --locked --manifest-path risc0/attestation/host/Cargo.toml --features cuda --bin prove_attestation_bundle_v1 -- --witness-hex "${w1}")"
          b2="$(cargo run --release --locked --manifest-path risc0/attestation/host/Cargo.toml --features cuda --bin prove_attestation_bundle_v1 -- --witness-hex "${w2}")"

          b1_hex="$(printf '%s\n' "${b1}" | grep -E '^[0-9a-fA-F]+$' | tail -n 1)"
          b2_hex="$(printf '%s\n' "${b2}" | grep -E '^[0-9a-fA-F]+$' | tail -n 1)"
          if [[ -z "${b1_hex}" || -z "${b2_hex}" ]]; then
            echo "failed to extract attestation bundle hex output" >&2
            exit 1
          fi

          info1="$(/tmp/juno-intents orp-attestation-info --bundle-hex "${b1_hex}")"
          info2="$(/tmp/juno-intents orp-attestation-info --bundle-hex "${b2_hex}")"
          echo "${info1}" >&2
          echo "${info2}" >&2

          op1="$(printf '%s\n' "${info1}" | sed -nE 's/^operator_pubkey=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | head -n 1)"
          op2="$(printf '%s\n' "${info2}" | sed -nE 's/^operator_pubkey=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | head -n 1)"
          meas1="$(printf '%s\n' "${info1}" | sed -nE 's/^measurement=([0-9a-fA-F]{64})$/\\1/p' | head -n 1)"
          meas2="$(printf '%s\n' "${info2}" | sed -nE 's/^measurement=([0-9a-fA-F]{64})$/\\1/p' | head -n 1)"
          if [[ -z "${op1}" || -z "${op2}" || -z "${meas1}" || -z "${meas2}" ]]; then
            echo "failed to parse attestation bundle info" >&2
            exit 1
          fi
          if [[ "${meas1}" != "${meas2}" ]]; then
            echo "enclave measurements mismatch (expected same EIF): ${meas1} != ${meas2}" >&2
            exit 1
          fi

          solver_pub="$(solana-keygen pubkey /tmp/juno-secrets/solver.json)"
          echo "initializing ORP config (admin=${solver_pub})..." >&2
          SOLANA_RPC_URL="${RPC_URL}" /tmp/juno-intents init-orp \
            --orp-program-id "${ORP_PROGRAM_ID}" \
            --deployment-id "${JUNO_E2E_DEPLOYMENT_ID}" \
            --admin "${solver_pub}" \
            --junocash-chain-id "${CHAIN_ID}" \
            --junocash-genesis-hash "${JUNOCASH_GENESIS_HASH}" \
            --verifier-router-program "${VERIFIER_ROUTER_PROGRAM_ID}" \
            --verifier-program-id "${VERIFIER_PROGRAM_ID}" \
            --allowed-measurement "${meas1}" \
            --payer-keypair /tmp/juno-secrets/solver.json >/dev/null

          echo "registering ORP operators..." >&2
          SOLANA_RPC_URL="${RPC_URL}" /tmp/juno-intents orp-register-operator \
            --orp-program-id "${ORP_PROGRAM_ID}" \
            --deployment-id "${JUNO_E2E_DEPLOYMENT_ID}" \
            --bundle-hex "${b1_hex}" \
            --payer-keypair /tmp/juno-secrets/solver.json >/dev/null
          SOLANA_RPC_URL="${RPC_URL}" /tmp/juno-intents orp-register-operator \
            --orp-program-id "${ORP_PROGRAM_ID}" \
            --deployment-id "${JUNO_E2E_DEPLOYMENT_ID}" \
            --bundle-hex "${b2_hex}" \
            --payer-keypair /tmp/juno-secrets/solver.json >/dev/null

          {
            echo "JUNO_E2E_CRP_OPERATOR1_PUBKEY=${op1}"
            echo "JUNO_E2E_CRP_OPERATOR2_PUBKEY=${op2}"
          } >> "$GITHUB_ENV"

      - name: Prepare ephemeral deployment (init CRP + IEP)
        run: |
          set -euo pipefail

          if [[ -z "${RPC_URL:-}" || -z "${ADMIN:-}" || -z "${FEE_BPS:-}" || -z "${FEE_COLLECTOR:-}" ]]; then
            echo "base deployment missing required fields (rpc_url/admin/fee_bps/fee_collector)" >&2
            exit 1
          fi
          if [[ -z "${CRP_PROGRAM_ID:-}" || -z "${IEP_PROGRAM_ID:-}" || -z "${RV_PROGRAM_ID:-}" ]]; then
            echo "base deployment missing required program IDs (CRP/IEP/RV)" >&2
            exit 1
          fi
          if [[ -z "${VERIFIER_ROUTER_PROGRAM_ID:-}" || -z "${VERIFIER_ROUTER:-}" || -z "${VERIFIER_ENTRY:-}" || -z "${VERIFIER_PROGRAM_ID:-}" ]]; then
            echo "base deployment missing required verifier router fields" >&2
            exit 1
          fi
          if [[ -z "${JUNOCASH_CHAIN:-}" || -z "${JUNOCASH_GENESIS_HASH:-}" ]]; then
            echo "base deployment missing required JunoCash chain info (junocash_chain/junocash_genesis_hash)" >&2
            exit 1
          fi

          deployment_id="${JUNO_E2E_DEPLOYMENT_ID}"
          e2e_deployment="${JUNO_E2E_DEPLOYMENT_NAME}"
          if [[ -z "${deployment_id:-}" || -z "${e2e_deployment:-}" ]]; then
            echo "missing deployment_id/name env" >&2
            exit 1
          fi

          rpc="${RPC_URL}"
          echo "solana_rpc_url=${rpc}" >&2

          crp_mode="${JUNO_E2E_CRP_MODE:-v1}"
          if [[ "${crp_mode}" != "v1" && "${crp_mode}" != "v2" ]]; then
            echo "invalid JUNO_E2E_CRP_MODE: ${crp_mode} (want v1 or v2)" >&2
            exit 1
          fi
          if [[ "${crp_mode}" == "v2" && -z "${ORP_PROGRAM_ID:-}" ]]; then
            echo "crp_mode=v2 but base deployment is missing operator_registry_program_id" >&2
            exit 1
          fi

          op1_pub="$(solana-keygen pubkey /tmp/juno-secrets/crp-operator-1.json)"
          op2_pub="$(solana-keygen pubkey /tmp/juno-secrets/crp-operator-2.json)"
          if [[ "${crp_mode}" == "v2" ]]; then
            if [[ -z "${JUNO_E2E_CRP_OPERATOR1_PUBKEY:-}" || -z "${JUNO_E2E_CRP_OPERATOR2_PUBKEY:-}" ]]; then
              echo "crp_mode=v2 but operator pubkeys not set (expected JUNO_E2E_CRP_OPERATOR{1,2}_PUBKEY)" >&2
              exit 1
            fi
            op1_pub="${JUNO_E2E_CRP_OPERATOR1_PUBKEY}"
            op2_pub="${JUNO_E2E_CRP_OPERATOR2_PUBKEY}"
          fi

          crp_log=""
          if ! crp_log="$(SOLANA_RPC_URL="${rpc}" go run ./cmd/juno-intents init-crp \
            --crp-program-id "${CRP_PROGRAM_ID}" \
            --deployment-id "${deployment_id}" \
            --admin "${ADMIN}" \
            --threshold 2 \
            --conflict-threshold 2 \
            --finalization-delay-slots 0 \
            $(if [[ "${crp_mode}" == "v2" ]]; then printf '%s' "--operator-registry-program ${ORP_PROGRAM_ID}"; fi) \
            --operator "${op1_pub}" \
            --operator "${op2_pub}" \
            --payer-keypair /tmp/juno-secrets/solver.json 2>&1)"; then
            printf '%s\n' "${crp_log}" >&2 || true
            echo "init-crp failed" >&2
            exit 1
          fi
          echo "${crp_log}" >&2
          crp_config="$(printf '%s\n' "${crp_log}" | sed -nE 's/^crp_config=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | tail -n 1)"
          if [[ -z "${crp_config}" ]]; then
            echo "failed to parse crp_config from init-crp output" >&2
            exit 1
          fi

          iep_log=""
          if ! iep_log="$(SOLANA_RPC_URL="${rpc}" go run ./cmd/juno-intents init-iep \
            --iep-program-id "${IEP_PROGRAM_ID}" \
            --deployment-id "${deployment_id}" \
            --fee-bps "${FEE_BPS}" \
            --fee-collector "${FEE_COLLECTOR}" \
            --checkpoint-registry-program "${CRP_PROGRAM_ID}" \
            --receipt-verifier-program "${RV_PROGRAM_ID}" \
            --verifier-router-program "${VERIFIER_ROUTER_PROGRAM_ID}" \
            --verifier-router "${VERIFIER_ROUTER}" \
            --verifier-entry "${VERIFIER_ENTRY}" \
            --verifier-program "${VERIFIER_PROGRAM_ID}" \
            --payer-keypair /tmp/juno-secrets/solver.json 2>&1)"; then
            printf '%s\n' "${iep_log}" >&2 || true
            echo "init-iep failed" >&2
            exit 1
          fi
          echo "${iep_log}" >&2
          iep_config="$(printf '%s\n' "${iep_log}" | sed -nE 's/^iep_config=([1-9A-HJ-NP-Za-km-z]{32,44})$/\\1/p' | tail -n 1)"
          if [[ -z "${iep_config}" ]]; then
            echo "failed to parse iep_config from init-iep output" >&2
            exit 1
          fi

          tmp_deployments="/tmp/juno-deployments-e2e.json"
          python3 - <<PY
          import json,time
          entry = {
            "name": "${e2e_deployment}",
            "cluster": "devnet",
            "rpc_url": "${RPC_URL}",
            "created_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
            "deployment_id": "${deployment_id}",
            "junocash_chain": "${JUNOCASH_CHAIN}",
            "junocash_genesis_hash": "${JUNOCASH_GENESIS_HASH}",
            "admin": "${ADMIN}",
            "checkpoint_registry_program_id": "${CRP_PROGRAM_ID}",
            "operator_registry_program_id": "${ORP_PROGRAM_ID:-}",
            "intent_escrow_program_id": "${IEP_PROGRAM_ID}",
            "receipt_verifier_program_id": "${RV_PROGRAM_ID}",
            "crp_config": "${crp_config}",
            "iep_config": "${iep_config}",
            "fee_bps": int("${FEE_BPS}"),
            "fee_collector": "${FEE_COLLECTOR}",
            "verifier_router_program_id": "${VERIFIER_ROUTER_PROGRAM_ID}",
            "verifier_router": "${VERIFIER_ROUTER}",
            "verifier_entry": "${VERIFIER_ENTRY}",
            "verifier_program_id": "${VERIFIER_PROGRAM_ID}",
            "crp_threshold": 2,
            "crp_conflict_threshold": 2,
            "crp_finalization_delay_slots": 0,
            "crp_operators": ["${op1_pub}","${op2_pub}"],
            "upgrade_mode": "final",
          }
          if not entry.get("operator_registry_program_id"):
            entry.pop("operator_registry_program_id", None)
          alt = "${ADDRESS_LOOKUP_TABLE:-}"
          if alt:
            entry["address_lookup_table"] = alt
          out = {"deployments": [entry]}
          with open("${tmp_deployments}", "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2, sort_keys=True)
            f.write("\\n")
          PY

          echo "JUNO_E2E_DEPLOYMENT_NAME=${e2e_deployment}" >> "$GITHUB_ENV"
          echo "JUNO_E2E_DEPLOYMENT_FILE=${tmp_deployments}" >> "$GITHUB_ENV"

      - name: Run devnet e2e (both directions)
        env:
          RUST_LOG: info
        run: |
          set -euo pipefail
          ./scripts/e2e/devnet-testnet.sh \
            --deployment "${JUNO_E2E_DEPLOYMENT_NAME}" \
            --deployment-file "${JUNO_E2E_DEPLOYMENT_FILE}"

      - name: Cleanup Nitro enclaves (v2)
        if: ${{ always() && env.JUNO_E2E_CRP_MODE == 'v2' }}
        run: |
          set -euo pipefail
          sudo nitro-cli describe-enclaves || true
          if [[ -n "${JUNO_E2E_NITRO_ENCLAVE_ID1:-}" ]]; then
            sudo nitro-cli terminate-enclave --enclave-id "${JUNO_E2E_NITRO_ENCLAVE_ID1}" || true
          fi
          if [[ -n "${JUNO_E2E_NITRO_ENCLAVE_ID2:-}" ]]; then
            sudo nitro-cli terminate-enclave --enclave-id "${JUNO_E2E_NITRO_ENCLAVE_ID2}" || true
          fi
          sudo nitro-cli terminate-enclave --all || true
